{% extends 'layout/platform_dashboard_layout.html' %}
{% load static %}

{% block title %}
    è®¾ç½®
{% endblock %}

{% block css %}
    <link rel="stylesheet" href="{% static 'plugins/bootstrap-datepicker/css/bootstrap-datepicker.min.css' %}">
    <style>
        .pd-0 {
            padding: 0 !important;
        }
    </style>
{% endblock %}

{% block body %}

    <div class="row" >
        <div class="  col-md-3">
            <div class="card project">
                <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <div><h1 class="modal-title">æ–°å»ºé—®é¢˜</h1>
                        </div>
                </div>
                <div class="card-body">
                    <form id="addForm1" class="row g-3">
                    {% csrf_token %}
                    <div class="col-md-6">
                        <label for="{{ form.status.id_for_label }}" class="form-label">{{ form.status.label }}</label>
                        {{ form.status }}
                        <div class="error-msg"></div>
                    </div>
                    <div class="col-md-6">
                        <label for="{{ form.priority.id_for_label }}" class="form-label">{{ form.priority.label }}</label>
                        {{ form.priority }}
                        <div class="error-msg"></div>
                    </div>
                    <div class="col-md-6">
                        <label for="{{ form.assign.id_for_label }}" class="form-label">æŒ‡æ´¾ç»™</label>

                        {{ form.assign }}
                        <div class="error-msg"></div>
                    </div>
                    <div class="col-md-6">
                        <label for="{{ form.attention.id_for_label }}" class="form-label">å…³æ³¨è€…</label>
                        {{ form.attention }}
                        <div class="error-msg"></div>
                    </div>
                    <div class="col-md-6">
                        <label for="{{ form.start_date.id_for_label }}" class="form-label">å¼€å§‹æ—¶é—´</label>
                        <div class="input-group">
                            <span class="input-group-text">ğŸ“…</span>
                            {{ form.start_date }}
                        </div>
                        <div class="error-msg"></div>
                    </div>
                    <div class="col-md-6">
                        <label for="{{ form.end_date.id_for_label }}" class="form-label">æˆªæ­¢æ—¶é—´</label>
                        <div class="input-group">
                            <span class="input-group-text">ğŸ“…</span>
                            {{ form.end_date }}
                        </div>
                        <div class="error-msg"></div>
                    </div>
                    <div class="col-md-6">
                        <label for="{{ form.mode.id_for_label }}" class="form-label">æ¨¡å¼</label>
                        {{ form.mode }}
                        <div class="error-msg"></div>
                    </div>
                    <div class="col-md-6">
                        <label for="{{ form.parent.id_for_label }}" class="form-label">çˆ¶é—®é¢˜</label>
                        {{ form.parent }}
                        <div class="error-msg"></div>
                    </div>
                    <div class="col-12" style="text-align: right">
                        <a type="button" class="btn btn-primary"  id="btnAddSubmit">æ·»åŠ </a>
                    </div>
                        <hr>
                </form>
                    <div class="modal-footer">
                            <br>
                            <a type="button" class="btn btn-secondary" href="{% url 'issue' request.tracer.project.id %}">å–æ¶ˆ</a>
                        </div>
                </div>
            </div>
        </div>
        {#   å³è¾¹         #}
        <div class=" col-md-9">
            <div class="card project">
                <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <div><a>â“é—®é¢˜</a></div>
                </div>
                <div class="card-body">
                    <form id="addForm2" class="row g-3">
                    {% csrf_token %}
                    <div class="col-md-12">
                        <label for="{{ form.issues_type.id_for_label }}" class="form-label">{{ form.issues_type.label }}</label>
                        {{ form.issues_type }}
                        <div class="error-msg"></div>
                    </div>
                    <div class="col-md-12">
                        <label for="{{ form.subject.id_for_label }}" class="form-label">{{ form.subject.label }}</label>
                        {{ form.subject }}
                        <div class="error-msg"></div>
                    </div>
                    <div class="col-md-12">
                        <label for="{{ form.module.id_for_label }}" class="form-label">{{ form.module.label }}</label>
                        {{ form.module }}
                        <div class="error-msg"></div>
                    </div>
                    <div class="col-md-12">
                        <label for="{{ form.desc.id_for_label }}" class="form-label">{{ form.desc.label }}</label>
                        <div id="editor">
                            {{ form.media }}
                            {{ form.desc }}
                        </div>
                        <div class="error-msg"></div>
                    </div>
                </form>

                </div>
                <div class="card-footer">

                </div>
            </div>
        </div>
    </div>


{% endblock %}

{% block JavaScript %}
<script src="{% static 'plugins/bootstrap-datepicker/js/bootstrap-datepicker.min.js' %}"></script>
<script src="{% static 'plugins/bootstrap-datepicker/locales/bootstrap-datepicker.zh-CN.min.js' %}"></script>
<script>


$(function (){
    initdate();
    creatIssue();
});
function initdate(){
    $('#id_start_date,#id_end_date').datepicker({
        format:'yyyy-mm-dd',
        startDate:'0',
        language:"zh-CN",
        autoClose:true
    })
}
function creatIssue(){
        $("#btnAddSubmit").click(function (){
            // è·å–ç¬¬ä¸€ä¸ªè¡¨å•çš„åºåˆ—åŒ–æ•°æ®
            var formData1 = $("#addForm1").serialize();
            // è·å–ç¬¬äºŒä¸ªè¡¨å•çš„åºåˆ—åŒ–æ•°æ®
            var formData2 = $("#addForm2").serialize();

            // å°†ä¸¤ä¸ªè¡¨å•çš„åºåˆ—åŒ–æ•°æ®åˆå¹¶ä¸ºä¸€ä¸ªå¯¹è±¡
            var combinedData = formData1 + '&' + formData2;
            // å‘é€ AJAX è¯·æ±‚
            $.ajax({
                // è¯·æ±‚çš„ URL
                url:"{% url 'issue_add' request.tracer.project.id %}",
                // è¯·æ±‚ç±»å‹
                type:'post',
                // å‘é€çš„æ•°æ®ï¼Œä½¿ç”¨è¡¨å•çš„åºåˆ—åŒ–æ•°æ®
                data:combinedData,
                // æœŸæœ›è¿”å›çš„æ•°æ®ç±»å‹
                dataType:"JSON",
                // è¯·æ±‚æˆåŠŸåçš„å›è°ƒå‡½æ•°
                success: function (res){
                    console.log(res);
                    // æ¸…ç©ºæ‰€æœ‰é”™è¯¯ä¿¡æ¯
                    $(".error-msg").empty();
                    // æ ¹æ®è¿”å›çš„çŠ¶æ€å¤„ç†å“åº”ç»“æœ
                    if(res.status){
                        window.location.href = "{% url 'issue' request.tracer.project.id %}";
                    }else{
                        // å¾ªç¯éå†é”™è¯¯ä¿¡æ¯ï¼Œå¹¶å°†é”™è¯¯ä¿¡æ¯æ˜¾ç¤ºåœ¨ç›¸åº”çš„è¡¨å•å­—æ®µä¸‹æ–¹
                        $.each(res.Error,function (name,value){
                            $("#id_"+name).next().text(value[0]);
                        })
                    }
                }
            })
        })
    }

</script>

{% endblock %}