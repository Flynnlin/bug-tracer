{% extends 'layout/platform_dashboard_layout.html' %}

{% block title %}
    æ–‡ä»¶ç®¡ç†
{% endblock %}

{% block css %}
    <style>

    </style>
{% endblock %}

{% block body %}
<div class="card project">
    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
        <div><a href="{% url 'project_file' request.tracer.project.id%}">ğŸ“‚æ–‡ä»¶åº“ /</a>>
            {% for folder in path %}
        {#     å½“å‰è·¯å¾„       #}
            <a href="{% url 'project_file' request.tracer.project.id%}?folder_id={{ folder.id }}">{{ folder.name }}</a>>/
        {% endfor %}</div>
        <div>
            <a class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadModal" style="vertical-align: middle;">ä¸Šä¼ </a>
            <a class="btn btn-dark"  data-bs-toggle="modal" data-bs-target="#creatFolderModal" style="vertical-align: middle;">æ–°å»ºæ–‡ä»¶å¤¹</a>
        </div>
    </div>
    <div class="card-body">
        <table class="table">
            <thead>
                <tr>
                    <th>åç§°</th>
                    <th>å¤§å°</th>
                    <th>æ›´æ–°è€…</th>
                    <th>æ›´æ–°æ—¶é—´</th>
                    <th>æ“ä½œ</th>
                    <th></th>
                </tr>
            </thead>

            <tbody>
            {% for f in files %}
                <tr>
                    <th>{% if f.file_type == 2 %}<a href="{% url 'project_file' request.tracer.project.id %}?folder_id={{ f.id }}">{{ f.name }}ğŸ“‚</a>{% else %}{{ f.name }}{% endif %}
                    </th>
                    <td>{% if f.file_type == 1 %}
                            {% if f.file_size > 1048576 %}
                                {% widthratio f.file_size 1048576 1 %}MB
                            {% else %}
                                {% widthratio f.file_size 1024 1 %}KB
                            {% endif %}
                     {% endif %}</td>
                    <td>{{ f.update_user.username }}</td>
                    <td>{{ f.update_datetime }}</td>
                    <td>
                        <button class = "deletebtn" data-bs-toggle="modal" data-bs-target="#confirmDeleteModal" fid="{{ f.id }}">ğŸš®</button>
                        {% if f.file_type == 1 %}<a href="{{ f.file_path }}">ğŸ“¥</a>{% endif %}
                    </td>

                </tr>
            {% endfor %}

            </tbody>

        </table>


      </div>
</div>

{#   ä¸Šä¼ æ–‡ä»¶å¼¹çª—     #}
<div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmDeleteModalLabel">ä¸Šä¼ æ–‡ä»¶</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id = 'upload-file' method="post" enctype="multipart/form-data" class="mb-4">
            <div class="mb-3">
                <label for="file" class="form-label">é€‰æ‹©æ–‡ä»¶</label>
                <input type="file" class="form-control" id="fileInput" name="file">
            </div>
            <button id="uploadBtn" type="button" class="btn btn-primary">ä¸Šä¼ </button>
        </form>
      </div>
    </div>
  </div>
</div>
{# æ–°å»ºæ–‡ä»¶å¤¹å¼¹çª—  #}
<div class="modal fade" id="creatFolderModal" tabindex="-1" aria-labelledby="creatFolderModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmDeleteModalLabel">æ–°å»ºæ–‡ä»¶å¤¹</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id = 'folder-name'  method="post"  class="mb-4">
            <div class="mb-3">
                <label for="file" class="form-label">æ–‡ä»¶å¤¹å</label>
                <input type="text" class="form-control" id="FolderName" name="FolderName">
            </div>
            <button id="creatFolderBtn" type="button" class="btn btn-primary">æ–°å»º</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- ç¡®è®¤åˆ é™¤è­¦å‘Šå¼¹çª— -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="confirmDeleteModalLabel">ç¡®è®¤åˆ é™¤</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            ç¡®è®¤è¦åˆ é™¤è¿™ä¸ªæ–‡ä»¶å—ï¼Ÿæ‰€å±æ–‡ä»¶ä¹Ÿå°†è¢«åˆ é™¤å“¦ï¼ï¼
            <input type="hidden" id="file_id">
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
            <!-- ç¡®è®¤åˆ é™¤æŒ‰é’® -->
            <button type="button" class="btn btn-danger" id="confirmDeleteBtn">ç¡®è®¤åˆ é™¤</button>
          </div>
        </div>
      </div>
    </div>

{% endblock %}

{% block JavaScript %}
    <script>
        $(function (){
            uploadFile();
            creatFolder();
            delEvent();
        });
        function uploadFile()   {
            $('#uploadBtn').click(function () {
                // è·å–æ–‡ä»¶è¾“å…¥æ¡†çš„æ–‡ä»¶
                var file = document.getElementById('fileInput').files[0];
                var path = '';
                // åˆ›å»º FormData å¯¹è±¡ï¼Œå¹¶å°†æ–‡ä»¶æ·»åŠ åˆ°å…¶ä¸­
                var formData = new FormData();
                formData.append('file', file);
                {% for folder in path %}
                    path+='{{ folder.name }}/'
                {% endfor %}
                formData.append('path', path);
                formData.append('file_type', 1);

                $.ajax({
                    url: '{% url 'project_file_upload' request.tracer.project.id %}?folder={{ folder_id }}',
                    type: 'POST',
                    processData: false, // ä¸å¯¹æ•°æ®è¿›è¡Œå¤„ç†
                    contentType: false, // ä¸è®¾ç½® content-type
                    data: formData, // å°†æ–‡ä»¶æ•°æ®ä½œä¸º FormData å‘é€
                    success: function (response) {
                        console.log(response);
                        // å¤„ç†æˆåŠŸçš„å“åº”
                        if (response.status) {
                            location.reload(); // é‡æ–°åŠ è½½é¡µé¢
                        } else {
                            alert(response.msg)
                        }
                    },
                    error: function(xhr, status, error) {
                        // å¤„ç†è¯·æ±‚é”™è¯¯
                        console.error('There was a problem with the upload:', error);
                    }
                });
            })
        }
        function creatFolder() {
            $('#creatFolderBtn').click(function () {
                // è·å–æ–‡ä»¶è¾“å…¥æ¡†çš„æ–‡ä»¶
                var folder_name = document.getElementById('FolderName').value;
                var path = '';
                // åˆ›å»º FormData å¯¹è±¡ï¼Œå¹¶å°†æ–‡ä»¶æ·»åŠ åˆ°å…¶ä¸­
                var formData = new FormData();
                formData.append('file', folder_name);
                {% for folder in path %}
                    path+='{{ folder.name }}/'
                {% endfor %}
                formData.append('path', path);
                formData.append('file_type', 2);

                $.ajax({
                    url: '{% url 'project_file_upload' request.tracer.project.id %}?folder={{ folder_id }}',
                    type: 'POST',
                    processData: false, // ä¸å¯¹æ•°æ®è¿›è¡Œå¤„ç†
                    contentType: false, // ä¸è®¾ç½® content-type
                    data: formData, // å°†æ–‡ä»¶æ•°æ®ä½œä¸º FormData å‘é€
                    success: function (response) {
                        console.log(response);
                        // å¤„ç†æˆåŠŸçš„å“åº”
                        if (response.status) {
                            location.reload(); // é‡æ–°åŠ è½½é¡µé¢
                        } else {
                            alert(response.msg)
                        }
                    },
                    error: function(xhr, status, error) {
                        // å¤„ç†è¯·æ±‚é”™è¯¯
                        console.error('There was a problem with the upload:', error);
                    }
                });
            })
        }
        function delEvent(){
            $(".deletebtn").click(function () {
                var folder = $(this).attr('fid');
                console.log(folder)
                $('#file_id').val(folder);
            });

            $('#confirmDeleteBtn').click(function () {
                // f_id
                var file_id = $('#file_id').val();
                var path = '';
                // åˆ›å»º FormData å¯¹è±¡ï¼Œå¹¶å°†æ–‡ä»¶æ·»åŠ åˆ°å…¶ä¸­
                var formData = new FormData();
                {% for folder in path %}
                    path+='{{ folder.name }}/'
                {% endfor %}
                formData.append('path', path);
                formData.append('file_id', file_id);

                $.ajax({
                    url: '{% url 'project_file_delete' request.tracer.project.id %}?folder={{ folder_id }}',
                    type: 'POST',
                    processData: false, // ä¸å¯¹æ•°æ®è¿›è¡Œå¤„ç†
                    contentType: false, // ä¸è®¾ç½® content-type
                    data: formData, // å°†æ–‡ä»¶æ•°æ®ä½œä¸º FormData å‘é€
                    success: function (response) {
                        console.log(response);
                        // å¤„ç†æˆåŠŸçš„å“åº”
                        if (response.status) {
                            location.reload(); // é‡æ–°åŠ è½½é¡µé¢
                        } else {
                            alert(response.msg)
                        }
                    },
                    error: function(xhr, status, error) {
                        // å¤„ç†è¯·æ±‚é”™è¯¯
                        console.error('There was a problem with the upload:', error);
                    }
                });
            })
        }



</script>
{% endblock %}